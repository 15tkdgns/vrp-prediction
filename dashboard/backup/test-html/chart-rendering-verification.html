<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ğŸ“Š Chart Rendering Verification</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .verification-container { max-width: 1200px; margin: 0 auto; }
        .test-card { 
            background: white; 
            margin: 15px 0; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-card.success { border-left: 5px solid #4caf50; }
        .test-card.error { border-left: 5px solid #f44336; }
        .test-card.warning { border-left: 5px solid #ff9800; }
        .chart-container { 
            width: 100%; 
            height: 300px; 
            margin: 20px 0; 
            border: 1px solid #ddd; 
            border-radius: 8px;
            padding: 10px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ok { background: #4caf50; }
        .status-error { background: #f44336; }
        .status-loading { background: #ff9800; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .info-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="verification-container">
        <h1>ğŸ“Š Chart Rendering Verification System</h1>
        <p><strong>ì‹¤ì‹œê°„ ì°¨íŠ¸ ë Œë”ë§ ìƒíƒœ ë° ì„±ëŠ¥ ê²€ì¦</strong></p>

        <!-- 1. ì‹œìŠ¤í…œ ìƒíƒœ -->
        <div class="test-card" id="system-status">
            <h2><span class="status-indicator status-loading" id="system-indicator"></span>ì‹œìŠ¤í…œ ìƒíƒœ</h2>
            <div class="info-grid" id="system-info">
                <div class="info-item">Chart.js ë²„ì „: <span id="chartjs-version">í™•ì¸ ì¤‘...</span></div>
                <div class="info-item">API ì„œë²„: <span id="api-server">í™•ì¸ ì¤‘...</span></div>
                <div class="info-item">ë°ì´í„° ë§¤ë‹ˆì €: <span id="data-manager">í™•ì¸ ì¤‘...</span></div>
                <div class="info-item">ì»´í¬ë„ŒíŠ¸: <span id="components">í™•ì¸ ì¤‘...</span></div>
            </div>
        </div>

        <!-- 2. API ë°ì´í„° í…ŒìŠ¤íŠ¸ -->
        <div class="test-card" id="api-test">
            <h2><span class="status-indicator status-loading" id="api-indicator"></span>API ë°ì´í„° ê²€ì¦</h2>
            <div id="api-data">API ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...</div>
        </div>

        <!-- 3. Top 4 ì£¼ì‹ ì°¨íŠ¸ ë Œë”ë§ -->
        <div class="test-card" id="top4-test">
            <h2><span class="status-indicator status-loading" id="top4-indicator"></span>Top 4 ì£¼ì‹ ì°¨íŠ¸ ë Œë”ë§</h2>
            <div id="top4-status">ì°¨íŠ¸ ìƒì„± ì¤‘...</div>
            <div id="top4-charts" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Top 4 ì£¼ì‹ ì°¨íŠ¸ë“¤ -->
            </div>
        </div>

        <!-- 4. S&P 500 ìœ„ì ¯ í…ŒìŠ¤íŠ¸ -->
        <div class="test-card" id="sp500-test">
            <h2><span class="status-indicator status-loading" id="sp500-indicator"></span>S&P 500 ì°¨íŠ¸ ìœ„ì ¯</h2>
            <div id="sp500-status">S&P 500 ì°¨íŠ¸ ìƒì„± ì¤‘...</div>
            <div class="chart-container">
                <canvas id="sp500-chart"></canvas>
            </div>
        </div>

        <!-- 5. ì„±ëŠ¥ ë©”íŠ¸ë¦­ -->
        <div class="test-card" id="performance-metrics">
            <h2><span class="status-indicator status-loading" id="perf-indicator"></span>ì„±ëŠ¥ ë©”íŠ¸ë¦­</h2>
            <div class="info-grid" id="performance-info">
                <div class="info-item">ì´ ë Œë”ë§ ì‹œê°„: <span id="render-time">ì¸¡ì • ì¤‘...</span></div>
                <div class="info-item">API ì‘ë‹µ ì‹œê°„: <span id="api-time">ì¸¡ì • ì¤‘...</span></div>
                <div class="info-item">ì°¨íŠ¸ ìƒì„± ê°œìˆ˜: <span id="chart-count">ê³„ì‚° ì¤‘...</span></div>
                <div class="info-item">ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: <span id="memory-usage">í™•ì¸ ì¤‘...</span></div>
            </div>
        </div>
    </div>

    <!-- ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ -->
    <script src="js/data-manager.js"></script>
    <script src="js/chart-manager.js"></script>
    <script src="js/components.js"></script>
    <script src="js/sp500-widget.js"></script>

    <script>
        class ChartVerificationSystem {
            constructor() {
                this.startTime = Date.now();
                this.results = {};
                this.chartCount = 0;
            }

            async init() {
                console.log('ğŸ§ª Chart Verification System ì‹œì‘...');
                
                try {
                    await this.checkSystemStatus();
                    await this.testAPIData();
                    await this.testTop4Charts();
                    await this.testSP500Widget();
                    await this.calculatePerformanceMetrics();
                    
                    console.log('âœ… ëª¨ë“  ê²€ì¦ ì™„ë£Œ!', this.results);
                } catch (error) {
                    console.error('âŒ ê²€ì¦ ì‹¤íŒ¨:', error);
                }
            }

            async checkSystemStatus() {
                console.log('1ï¸âƒ£ ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸...');
                
                // Chart.js í™•ì¸
                const chartjsVersion = window.Chart ? Chart.version : 'Not Found';
                document.getElementById('chartjs-version').textContent = chartjsVersion;
                
                // API ì„œë²„ í™•ì¸
                try {
                    const response = await fetch('http://localhost:8091/api/stocks/live', { timeout: 3000 });
                    document.getElementById('api-server').textContent = response.ok ? 'âœ… ì—°ê²°ë¨' : 'âŒ ì˜¤ë¥˜';
                    this.results.apiServer = response.ok;
                } catch (error) {
                    document.getElementById('api-server').textContent = 'âŒ ì—°ê²° ì‹¤íŒ¨';
                    this.results.apiServer = false;
                }
                
                // ë°ì´í„° ë§¤ë‹ˆì € í™•ì¸
                const hasDataManager = !!window.OptimizedDataManager;
                document.getElementById('data-manager').textContent = hasDataManager ? 'âœ… ë¡œë“œë¨' : 'âŒ ëˆ„ë½';
                this.results.dataManager = hasDataManager;
                
                // ì»´í¬ë„ŒíŠ¸ í™•ì¸
                const components = ['ChartManager', 'StockGrid'];
                const allComponents = components.every(c => !!window[c]);
                document.getElementById('components').textContent = allComponents ? 'âœ… ëª¨ë“  ì»´í¬ë„ŒíŠ¸ ë¡œë“œë¨' : 'âŒ ì¼ë¶€ ëˆ„ë½';
                this.results.components = allComponents;
                
                // ì‹œìŠ¤í…œ ìƒíƒœ ì—…ë°ì´íŠ¸
                const systemOk = this.results.apiServer && this.results.dataManager && this.results.components;
                this.updateIndicator('system-indicator', systemOk);
                document.getElementById('system-status').className = 'test-card ' + (systemOk ? 'success' : 'error');
            }

            async testAPIData() {
                console.log('2ï¸âƒ£ API ë°ì´í„° í…ŒìŠ¤íŠ¸...');
                
                try {
                    const startTime = Date.now();
                    const response = await fetch('http://localhost:8091/api/stocks/live');
                    const data = await response.json();
                    const endTime = Date.now();
                    
                    this.results.apiResponseTime = endTime - startTime;
                    
                    if (data && data.predictions && data.predictions.length > 0) {
                        document.getElementById('api-data').innerHTML = `
                            âœ… API ë°ì´í„° ê²€ì¦ ì„±ê³µ<br>
                            â€¢ ì‘ë‹µ ì‹œê°„: ${this.results.apiResponseTime}ms<br>
                            â€¢ ì£¼ì‹ ê°œìˆ˜: ${data.predictions.length}ê°œ<br>
                            â€¢ ì‹œì¥ ì‹ ë¢°ë„: ${(data.market_summary.confidence_level * 100).toFixed(1)}%<br>
                            â€¢ ì²« ë²ˆì§¸ ì£¼ì‹: ${data.predictions[0].symbol} - $${data.predictions[0].current_price}
                        `;
                        
                        this.results.apiData = data;
                        this.updateIndicator('api-indicator', true);
                        document.getElementById('api-test').className = 'test-card success';
                    } else {
                        throw new Error('API ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜');
                    }
                } catch (error) {
                    document.getElementById('api-data').textContent = `âŒ API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`;
                    this.updateIndicator('api-indicator', false);
                    document.getElementById('api-test').className = 'test-card error';
                    this.results.apiData = null;
                }
            }

            async testTop4Charts() {
                console.log('3ï¸âƒ£ Top 4 ì£¼ì‹ ì°¨íŠ¸ ë Œë”ë§ í…ŒìŠ¤íŠ¸...');
                
                try {
                    if (!this.results.apiData) {
                        throw new Error('API ë°ì´í„°ê°€ ì—†ìŒ');
                    }
                    
                    const chartManager = new ChartManager();
                    const top4Container = document.getElementById('top4-charts');
                    const stocks = this.results.apiData.predictions.slice(0, 4);
                    
                    const chartPromises = stocks.map(async (stock, index) => {
                        const chartDiv = document.createElement('div');
                        chartDiv.innerHTML = `
                            <h4>${stock.symbol}</h4>
                            <p>í˜„ì¬ê°€: $${stock.current_price} | ì˜ˆì¸¡: ${stock.predicted_direction}</p>
                            <div style="height: 200px; position: relative;">
                                <canvas id="top4-chart-${index}"></canvas>
                            </div>
                        `;
                        top4Container.appendChild(chartDiv);
                        
                        const canvas = document.getElementById(`top4-chart-${index}`);
                        return await chartManager.createStockChart(canvas.getContext('2d'), stock);
                    });
                    
                    const startTime = Date.now();
                    const charts = await Promise.all(chartPromises);
                    const endTime = Date.now();
                    
                    this.chartCount += charts.length;
                    this.results.top4RenderTime = endTime - startTime;
                    
                    document.getElementById('top4-status').innerHTML = `
                        âœ… Top 4 ì°¨íŠ¸ ë Œë”ë§ ì™„ë£Œ<br>
                        â€¢ ìƒì„±ëœ ì°¨íŠ¸: ${charts.length}ê°œ<br>
                        â€¢ ë Œë”ë§ ì‹œê°„: ${this.results.top4RenderTime}ms<br>
                        â€¢ ì°¨íŠ¸ë‹¹ í‰ê· : ${(this.results.top4RenderTime / charts.length).toFixed(1)}ms
                    `;
                    
                    this.updateIndicator('top4-indicator', true);
                    document.getElementById('top4-test').className = 'test-card success';
                    
                } catch (error) {
                    document.getElementById('top4-status').textContent = `âŒ Top 4 ì°¨íŠ¸ ë Œë”ë§ ì‹¤íŒ¨: ${error.message}`;
                    this.updateIndicator('top4-indicator', false);
                    document.getElementById('top4-test').className = 'test-card error';
                }
            }

            async testSP500Widget() {
                console.log('4ï¸âƒ£ S&P 500 ìœ„ì ¯ í…ŒìŠ¤íŠ¸...');
                
                try {
                    const canvas = document.getElementById('sp500-chart');
                    const ctx = canvas.getContext('2d');
                    
                    // ëª¨í¬ S&P 500 ë°ì´í„° ìƒì„±
                    const sp500Data = {
                        current: 5627.45,
                        predicted: 5712.30,
                        confidence: 0.87,
                        change: 84.85,
                        changePercent: 1.54
                    };
                    
                    const startTime = Date.now();
                    
                    // S&P 500 ì°¨íŠ¸ ìƒì„±
                    const chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: this.generateDateLabels(30),
                            datasets: [{
                                label: 'S&P 500',
                                data: this.generateSP500PriceHistory(sp500Data.current, 30),
                                borderColor: '#007bff',
                                backgroundColor: 'rgba(0,123,255,0.1)',
                                borderWidth: 2,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: `S&P 500 - í˜„ì¬: $${sp500Data.current} | ì˜ˆì¸¡: $${sp500Data.predicted}`
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    title: {
                                        display: true,
                                        text: 'ê°€ê²©'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'ë‚ ì§œ'
                                    }
                                }
                            }
                        }
                    });
                    
                    const endTime = Date.now();
                    this.chartCount++;
                    this.results.sp500RenderTime = endTime - startTime;
                    
                    document.getElementById('sp500-status').innerHTML = `
                        âœ… S&P 500 ì°¨íŠ¸ ìƒì„± ì™„ë£Œ<br>
                        â€¢ ë Œë”ë§ ì‹œê°„: ${this.results.sp500RenderTime}ms<br>
                        â€¢ í˜„ì¬ê°€: $${sp500Data.current}<br>
                        â€¢ ì˜ˆì¸¡ê°€: $${sp500Data.predicted} (ì‹ ë¢°ë„: ${(sp500Data.confidence * 100).toFixed(1)}%)
                    `;
                    
                    this.updateIndicator('sp500-indicator', true);
                    document.getElementById('sp500-test').className = 'test-card success';
                    
                } catch (error) {
                    document.getElementById('sp500-status').textContent = `âŒ S&P 500 ì°¨íŠ¸ ì‹¤íŒ¨: ${error.message}`;
                    this.updateIndicator('sp500-indicator', false);
                    document.getElementById('sp500-test').className = 'test-card error';
                }
            }

            async calculatePerformanceMetrics() {
                console.log('5ï¸âƒ£ ì„±ëŠ¥ ë©”íŠ¸ë¦­ ê³„ì‚°...');
                
                const totalTime = Date.now() - this.startTime;
                const memoryInfo = performance.memory || {};
                
                document.getElementById('render-time').textContent = `${totalTime}ms`;
                document.getElementById('api-time').textContent = `${this.results.apiResponseTime || 'N/A'}ms`;
                document.getElementById('chart-count').textContent = `${this.chartCount}ê°œ`;
                document.getElementById('memory-usage').textContent = 
                    `${Math.round((memoryInfo.usedJSHeapSize || 0) / 1024 / 1024)}MB`;
                
                this.updateIndicator('perf-indicator', true);
                document.getElementById('performance-metrics').className = 'test-card success';
                
                this.results.performance = {
                    totalTime,
                    chartCount: this.chartCount,
                    memoryUsage: Math.round((memoryInfo.usedJSHeapSize || 0) / 1024 / 1024)
                };
            }

            updateIndicator(indicatorId, success) {
                const indicator = document.getElementById(indicatorId);
                indicator.className = 'status-indicator ' + (success ? 'status-ok' : 'status-error');
            }

            generateDateLabels(days) {
                const labels = [];
                for (let i = days; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' }));
                }
                return labels;
            }

            generateSP500PriceHistory(currentPrice, days) {
                const prices = [];
                let price = currentPrice * 0.98; // 30ì¼ ì „ ì‹œì‘ê°€
                
                for (let i = 0; i <= days; i++) {
                    // ëœë¤ ë³€ë™ (-1% ~ +1%)
                    const change = (Math.random() - 0.5) * 0.02;
                    price = price * (1 + change);
                    prices.push(Math.round(price * 100) / 100);
                }
                
                return prices;
            }
        }

        // ì‹œìŠ¤í…œ ì‹œì‘
        window.addEventListener('load', async () => {
            const verificationSystem = new ChartVerificationSystem();
            await verificationSystem.init();
        });
    </script>
</body>
</html>