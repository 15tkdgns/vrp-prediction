<!DOCTYPE html>
<html>
<head>
    <title>Main Dashboard Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .debug-section { background: white; margin: 15px 0; padding: 15px; border-radius: 5px; border: 1px solid #ddd; }
        .status { padding: 8px; margin: 8px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        .chart-debug { border: 2px solid #007bff; background: #f8f9ff; min-height: 300px; padding: 10px; }
        canvas { border: 1px solid #ccc; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 12px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ”§ ë©”ì¸ ëŒ€ì‹œë³´ë“œ ì°¨íŠ¸ ë””ë²„ê¹…</h1>
    
    <div id="debug-messages">
        <div class="status info">ğŸš€ ë©”ì¸ ëŒ€ì‹œë³´ë“œ ì°¨íŠ¸ ë””ë²„ê¹… ì‹œì‘...</div>
    </div>

    <div class="debug-section">
        <h2>1. í™˜ê²½ í™•ì¸</h2>
        <div id="env-status" class="status info">í™˜ê²½ í™•ì¸ ì¤‘...</div>
        <pre id="env-details"></pre>
    </div>

    <div class="debug-section">
        <h2>2. HTML ìš”ì†Œ í™•ì¸</h2>
        <div id="html-status" class="status info">HTML ìš”ì†Œ í™•ì¸ ì¤‘...</div>
        <pre id="html-details"></pre>
    </div>

    <div class="debug-section">
        <h2>3. JavaScript í´ë˜ìŠ¤ ë¡œë”© ìƒíƒœ</h2>
        <div id="js-status" class="status info">JavaScript ë¡œë”© ìƒíƒœ í™•ì¸ ì¤‘...</div>
        <pre id="js-details"></pre>
    </div>

    <div class="debug-section">
        <h2>4. ì°¨íŠ¸ ì´ˆê¸°í™” í…ŒìŠ¤íŠ¸</h2>
        <div id="chart-status" class="status info">ì°¨íŠ¸ ì´ˆê¸°í™” í…ŒìŠ¤íŠ¸ ì¤‘...</div>
        <div class="chart-debug">
            <canvas id="sp500-30day-chart" width="800" height="400"></canvas>
        </div>
        <pre id="chart-details"></pre>
    </div>

    <div class="debug-section">
        <h2>5. API ë°ì´í„° ì—°ê²° í…ŒìŠ¤íŠ¸</h2>
        <div id="api-status" class="status info">API ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...</div>
        <pre id="api-details"></pre>
    </div>

    <!-- Chart.js ë¡œë“œ (ë©”ì¸ ëŒ€ì‹œë³´ë“œì™€ ë™ì¼) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- ë©”ì¸ ëŒ€ì‹œë³´ë“œ JavaScriptë“¤ (ë™ì¼í•œ ìˆœì„œ) -->
    <script src="js/api-service.js?v=20250902_3"></script>
    <script src="js/data-manager.js?v=20250902_3"></script>
    <script src="js/chart-manager.js?v=20250902_3"></script>
    <script src="js/sp500-widget.js?v=20250902_5"></script>
    <script src="js/xai-visualization.js?v=20250902_3"></script>
    <script src="js/page-router.js?v=20250902_3"></script>
    <script src="js/components.js?v=20250902_3"></script>
    <script src="js/app.js?v=20250902_3"></script>

    <script>
        let debugLog = [];
        
        function addDebug(message, type = 'info') {
            console.log(message);
            debugLog.push({ message, type, time: new Date().toISOString() });
            
            const debugDiv = document.getElementById('debug-messages');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            debugDiv.appendChild(div);
        }

        function updateStatus(id, message, type = 'info') {
            const element = document.getElementById(id);
            if (element) {
                element.className = `status ${type}`;
                element.innerHTML = message;
            }
        }

        function updateDetails(id, content) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = content;
            }
        }

        // 1. í™˜ê²½ í™•ì¸
        function checkEnvironment() {
            const envInfo = {
                'Chart.js': typeof Chart !== 'undefined' ? `v${Chart.version || 'unknown'}` : 'Not loaded',
                'Location': window.location.href,
                'User Agent': navigator.userAgent,
                'Screen Size': `${window.innerWidth}x${window.innerHeight}`
            };

            const chartLoaded = typeof Chart !== 'undefined';
            updateStatus('env-status', 
                chartLoaded ? 'âœ… Chart.js ë¡œë“œë¨' : 'âŒ Chart.js ë¡œë“œ ì•ˆë¨',
                chartLoaded ? 'success' : 'error'
            );
            
            updateDetails('env-details', JSON.stringify(envInfo, null, 2));
            return chartLoaded;
        }

        // 2. HTML ìš”ì†Œ í™•ì¸
        function checkHTMLElements() {
            const elements = {
                'sp500-widget': !!document.querySelector('.sp500-widget'),
                'sp500-30day-chart': !!document.getElementById('sp500-30day-chart'),
                'sp500-current-price': !!document.getElementById('sp500-current-price'),
                'sp500-price-change': !!document.getElementById('sp500-price-change'),
                'sp500-predicted-price': !!document.getElementById('sp500-predicted-price')
            };

            const canvasElement = document.getElementById('sp500-30day-chart');
            const hasCanvas = !!canvasElement;
            
            updateStatus('html-status',
                hasCanvas ? 'âœ… Canvas ìš”ì†Œ ì¡´ì¬' : 'âŒ Canvas ìš”ì†Œ ì—†ìŒ',
                hasCanvas ? 'success' : 'error'
            );

            const details = Object.entries(elements)
                .map(([key, value]) => `${key}: ${value ? 'âœ…' : 'âŒ'}`)
                .join('\n');
            
            updateDetails('html-details', details);
            return hasCanvas;
        }

        // 3. JavaScript í´ë˜ìŠ¤ í™•ì¸
        function checkJavaScriptClasses() {
            const classes = {
                'Chart (Chart.js)': typeof Chart !== 'undefined',
                'SP500Widget': typeof SP500Widget !== 'undefined',
                'DashboardApp': typeof DashboardApp !== 'undefined',
                'ChartManager': typeof ChartManager !== 'undefined',
                'APIService': typeof APIService !== 'undefined',
                'OptimizedDataManager': typeof OptimizedDataManager !== 'undefined'
            };

            const allLoaded = Object.values(classes).every(Boolean);
            updateStatus('js-status',
                allLoaded ? 'âœ… ëª¨ë“  í•„ìˆ˜ í´ë˜ìŠ¤ ë¡œë“œë¨' : 'âš ï¸ ì¼ë¶€ í´ë˜ìŠ¤ ëˆ„ë½',
                allLoaded ? 'success' : 'warning'
            );

            const details = Object.entries(classes)
                .map(([key, value]) => `${key}: ${value ? 'âœ…' : 'âŒ'}`)
                .join('\n');
                
            updateDetails('js-details', details);
            return classes;
        }

        // 4. ì°¨íŠ¸ ì§ì ‘ ìƒì„± í…ŒìŠ¤íŠ¸
        function testChartCreation() {
            try {
                if (typeof Chart === 'undefined') {
                    throw new Error('Chart.jsê°€ ë¡œë“œë˜ì§€ ì•ŠìŒ');
                }

                const canvas = document.getElementById('sp500-30day-chart');
                if (!canvas) {
                    throw new Error('Canvas ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                }

                // SP500 ìŠ¤íƒ€ì¼ ì°¨íŠ¸ ìƒì„±
                const labels = [];
                const data1 = [];
                const data2 = [];
                
                for (let i = 0; i < 30; i++) {
                    labels.push(`Day ${i + 1}`);
                    data1.push(5500 + Math.random() * 200);
                    data2.push(5500 + Math.random() * 200);
                }

                const chart = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'ğŸ“ˆ ì‹¤ì œ ì£¼ê°€',
                                data: data1,
                                borderColor: '#0D47A1',
                                backgroundColor: 'rgba(27, 94, 32, 0.08)',
                                borderWidth: 2,
                                fill: false
                            },
                            {
                                label: 'ğŸ”® AI ì˜ˆì¸¡',
                                data: data2,
                                borderColor: '#FF5722',
                                borderDash: [6, 3],
                                borderWidth: 2,
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { title: { display: true, text: 'ê°€ê²© ($)' } }
                        }
                    }
                });

                updateStatus('chart-status', 'âœ… ì°¨íŠ¸ ì§ì ‘ ìƒì„± ì„±ê³µ!', 'success');
                updateDetails('chart-details', `Chart instance: ${chart.constructor.name}\nCanvas: ${canvas.id}\nDatasets: ${chart.data.datasets.length}`);
                
                return chart;
            } catch (error) {
                updateStatus('chart-status', `âŒ ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
                updateDetails('chart-details', `Error: ${error.message}\nStack: ${error.stack}`);
                return null;
            }
        }

        // 5. API ë°ì´í„° í…ŒìŠ¤íŠ¸
        async function testAPIData() {
            try {
                updateStatus('api-status', 'ğŸŒ API ë°ì´í„° ìš”ì²­ ì¤‘...', 'info');
                
                const response = await fetch('http://localhost:8091/api/stocks/live');
                if (!response.ok) {
                    throw new Error(`API ì‘ë‹µ ì‹¤íŒ¨: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                updateStatus('api-status', `âœ… API ë°ì´í„° ìˆ˜ì‹  ì„±ê³µ (${data.total_predictions}ê°œ)`, 'success');
                
                const apiInfo = {
                    status: data.status,
                    total_predictions: data.total_predictions,
                    timestamp: data.timestamp,
                    sample_prediction: data.predictions[0] || 'No predictions'
                };
                
                updateDetails('api-details', JSON.stringify(apiInfo, null, 2));
                return data;
            } catch (error) {
                updateStatus('api-status', `âŒ API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
                updateDetails('api-details', `Error: ${error.message}`);
                return null;
            }
        }

        // SP500Widget ì§ì ‘ í…ŒìŠ¤íŠ¸
        async function testSP500Widget() {
            try {
                addDebug('ğŸ§ª SP500Widget ì§ì ‘ í…ŒìŠ¤íŠ¸ ì‹œì‘', 'info');
                
                if (typeof SP500Widget === 'undefined') {
                    throw new Error('SP500Widget í´ë˜ìŠ¤ê°€ ì •ì˜ë˜ì§€ ì•ŠìŒ');
                }
                
                // ê¸°ì¡´ widget ì¸ìŠ¤í„´ìŠ¤ í™•ì¸
                if (window.sp500Widget) {
                    addDebug('âš ï¸ ê¸°ì¡´ SP500Widget ì¸ìŠ¤í„´ìŠ¤ ë°œê²¬ë¨', 'warning');
                }
                
                // ìƒˆ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° ì´ˆê¸°í™”
                const widget = new SP500Widget();
                await widget.init();
                
                addDebug('âœ… SP500Widget ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° ì´ˆê¸°í™” ì„±ê³µ', 'success');
                return widget;
            } catch (error) {
                addDebug(`âŒ SP500Widget í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
                return null;
            }
        }

        // ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        async function runAllTests() {
            addDebug('ğŸ” ë©”ì¸ ëŒ€ì‹œë³´ë“œ ì°¨íŠ¸ ë””ë²„ê¹… ì‹œì‘', 'info');
            
            // ìˆœì°¨ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
            setTimeout(() => {
                const chartLoaded = checkEnvironment();
                
                setTimeout(() => {
                    const hasCanvas = checkHTMLElements();
                    
                    setTimeout(() => {
                        const jsClasses = checkJavaScriptClasses();
                        
                        setTimeout(() => {
                            if (chartLoaded && hasCanvas) {
                                testChartCreation();
                            }
                            
                            setTimeout(() => {
                                testAPIData();
                                
                                // SP500Widget í…ŒìŠ¤íŠ¸
                                setTimeout(() => {
                                    if (jsClasses.SP500Widget) {
                                        testSP500Widget();
                                    }
                                }, 1000);
                            }, 1000);
                        }, 1000);
                    }, 500);
                }, 500);
            }, 1000);
        }

        // í˜ì´ì§€ ë¡œë“œ í›„ í…ŒìŠ¤íŠ¸ ì‹œì‘
        document.addEventListener('DOMContentLoaded', () => {
            addDebug('ğŸ“„ DOM ë¡œë“œ ì™„ë£Œ', 'info');
            runAllTests();
        });
    </script>
</body>
</html>