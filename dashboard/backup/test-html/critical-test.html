<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ğŸ” Critical System Test - Objective Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background: #f0f0f0; }
        .critical-container { max-width: 1200px; margin: 0 auto; }
        .test-section { 
            background: white; 
            margin: 20px 0; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 4px solid #dc3545;
        }
        .test-section.success { border-left-color: #28a745; }
        .test-section.warning { border-left-color: #ffc107; }
        .test-section.info { border-left-color: #17a2b8; }
        
        .reality-check {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .test-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
        }
        
        .test-card.fail { border-color: #dc3545; background: #f8d7da; }
        .test-card.pass { border-color: #28a745; background: #d4edda; }
        .test-card.unknown { border-color: #ffc107; background: #fff3cd; }
        
        .console-output {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .error-indicator {
            color: #ff4757;
            font-weight: bold;
        }
        
        .success-indicator {
            color: #2ed573;
            font-weight: bold;
        }
        
        .chart-test-area {
            border: 2px dashed #6c757d;
            padding: 20px;
            margin: 15px 0;
            min-height: 300px;
            background: white;
            border-radius: 8px;
        }
        
        .stress-test {
            background: #343a40;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="critical-container">
        <h1>ğŸ” Critical & Objective System Analysis</h1>
        
        <div class="reality-check">
            <h2>âš ï¸ REALITY CHECK</h2>
            <p><strong>ì§€ê¸ˆê¹Œì§€ì˜ í…ŒìŠ¤íŠ¸ëŠ” ëŒ€ë¶€ë¶„ HTTP ì‘ë‹µ í™•ì¸ì— ê·¸ì³¤ìŠµë‹ˆë‹¤.</strong></p>
            <p>ì‹¤ì œ ë¸Œë¼ìš°ì €ì—ì„œ ì°¨íŠ¸ê°€ ë³´ì´ëŠ”ì§€ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.</p>
        </div>

        <!-- 1. ì‹¤ì œ DOM ê²€ì‚¬ -->
        <div class="test-section" id="dom-reality">
            <h2>1. ğŸ“‹ ì‹¤ì œ DOM ìƒíƒœ ê²€ì‚¬</h2>
            <div id="dom-analysis" class="console-output">ë¶„ì„ ì¤‘...</div>
            <button onclick="analyzeDOMReality()" style="margin: 10px 0; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">DOM ì‹¤íƒœ ì¡°ì‚¬</button>
        </div>

        <!-- 2. JavaScript ì—ëŸ¬ ëª¨ë‹ˆí„°ë§ -->
        <div class="test-section" id="error-monitoring">
            <h2>2. ğŸš¨ JavaScript ì—ëŸ¬ ëª¨ë‹ˆí„°ë§</h2>
            <div id="error-log" class="console-output">ì—ëŸ¬ ë¡œê·¸ ëª¨ë‹ˆí„°ë§ ì¤‘...</div>
            <div class="test-grid">
                <div class="test-card unknown" id="error-count-card">
                    <h4>ì—ëŸ¬ ë°œìƒ íšŸìˆ˜</h4>
                    <div id="error-count">0</div>
                </div>
                <div class="test-card unknown" id="console-errors">
                    <h4>ì½˜ì†” ì—ëŸ¬</h4>
                    <div id="console-error-count">í™•ì¸ ì¤‘...</div>
                </div>
            </div>
        </div>

        <!-- 3. ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ì‹¤íŒ¨ ê°ì§€ -->
        <div class="test-section" id="network-analysis">
            <h2>3. ğŸŒ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ì‹¤íŒ¨ ê°ì§€</h2>
            <div id="network-results" class="test-grid">
                <!-- ë„¤íŠ¸ì›Œí¬ í…ŒìŠ¤íŠ¸ ê²°ê³¼ë“¤ -->
            </div>
            <button onclick="testNetworkReality()" style="margin: 10px 0; padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">ë„¤íŠ¸ì›Œí¬ ì‹¤íƒœ í™•ì¸</button>
        </div>

        <!-- 4. ì‹¤ì œ ì°¨íŠ¸ ë Œë”ë§ í…ŒìŠ¤íŠ¸ -->
        <div class="test-section" id="chart-reality">
            <h2>4. ğŸ“Š ì‹¤ì œ ì°¨íŠ¸ ë Œë”ë§ ê²€ì¦</h2>
            <div class="chart-test-area" id="chart-test-container">
                <p>ì°¨íŠ¸ ë Œë”ë§ í…ŒìŠ¤íŠ¸ ì˜ì—­</p>
                <canvas id="reality-test-chart" width="600" height="300"></canvas>
            </div>
            <div id="chart-reality-results">
                <button onclick="testChartReality()" style="margin: 10px 0; padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">ì°¨íŠ¸ ì‹¤ì œ ë Œë”ë§ í…ŒìŠ¤íŠ¸</button>
            </div>
        </div>

        <!-- 5. ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ -->
        <div class="test-section" id="stress-test">
            <h2>5. ğŸ’ª ì‹œìŠ¤í…œ ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸</h2>
            <div class="stress-test">
                <div id="stress-results">ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ ì¤€ë¹„ë¨</div>
                <button onclick="runStressTest()" style="margin: 10px 10px 10px 0; padding: 10px 20px; background: #ff6b6b; color: white; border: none; border-radius: 5px; cursor: pointer;">ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ ì‹œì‘</button>
                <button onclick="stopStressTest()" style="margin: 10px 0; padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">í…ŒìŠ¤íŠ¸ ì¤‘ë‹¨</button>
            </div>
        </div>

        <!-- 6. ì¹˜ëª…ì  ê²°í•¨ íƒì§€ -->
        <div class="test-section" id="fatal-flaws">
            <h2>6. â˜ ï¸ ì¹˜ëª…ì  ê²°í•¨ íƒì§€</h2>
            <div id="fatal-analysis" class="console-output">ì¹˜ëª…ì  ê²°í•¨ ë¶„ì„ ì¤‘...</div>
            <button onclick="detectFatalFlaws()" style="margin: 10px 0; padding: 10px 20px; background: #6f42c1; color: white; border: none; border-radius: 5px; cursor: pointer;">ì¹˜ëª…ì  ê²°í•¨ íƒì§€</button>
        </div>
    </div>

    <script>
        // ì—ëŸ¬ ì¹´ìš´í„°
        let errorCount = 0;
        let stressTestRunning = false;
        let stressInterval;

        // ì „ì—­ ì—ëŸ¬ ìºì²˜
        window.addEventListener('error', (e) => {
            errorCount++;
            document.getElementById('error-count').textContent = errorCount;
            document.getElementById('error-count-card').className = 'test-card fail';
            
            const errorLog = document.getElementById('error-log');
            errorLog.innerHTML += `<div class="error-indicator">[${new Date().toLocaleTimeString()}] ERROR: ${e.message} (${e.filename}:${e.lineno})</div>\n`;
            errorLog.scrollTop = errorLog.scrollHeight;
        });

        window.addEventListener('unhandledrejection', (e) => {
            errorCount++;
            document.getElementById('error-count').textContent = errorCount;
            document.getElementById('error-count-card').className = 'test-card fail';
            
            const errorLog = document.getElementById('error-log');
            errorLog.innerHTML += `<div class="error-indicator">[${new Date().toLocaleTimeString()}] UNHANDLED REJECTION: ${e.reason}</div>\n`;
            errorLog.scrollTop = errorLog.scrollHeight;
        });

        // 1. DOM ì‹¤íƒœ ì¡°ì‚¬
        function analyzeDOMReality() {
            const analysis = document.getElementById('dom-analysis');
            let report = '';
            
            try {
                // ì‹¤ì œë¡œ ì£¼ìš” ìš”ì†Œë“¤ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                const stockGrids = document.querySelectorAll('.stock-grid');
                const stockCards = document.querySelectorAll('.stock-card');
                const chartCanvases = document.querySelectorAll('canvas');
                const stockCharts = document.querySelectorAll('.stock-chart');
                
                report += `<div class="success-indicator">âœ… FOUND: ${stockGrids.length} stock-grid elements</div>\n`;
                report += `<div class="${stockCards.length > 0 ? 'success' : 'error'}-indicator">${stockCards.length > 0 ? 'âœ…' : 'âŒ'} FOUND: ${stockCards.length} stock-card elements</div>\n`;
                report += `<div class="${chartCanvases.length > 0 ? 'success' : 'error'}-indicator">${chartCanvases.length > 0 ? 'âœ…' : 'âŒ'} FOUND: ${chartCanvases.length} canvas elements</div>\n`;
                report += `<div class="${stockCharts.length > 0 ? 'success' : 'error'}-indicator">${stockCharts.length > 0 ? 'âœ…' : 'âŒ'} FOUND: ${stockCharts.length} stock-chart elements</div>\n`;
                
                // ì‹¤ì œ ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ í™•ì¸
                const chartInstances = Chart.instances ? Chart.instances.length : 0;
                report += `<div class="${chartInstances > 0 ? 'success' : 'error'}-indicator">${chartInstances > 0 ? 'âœ…' : 'âŒ'} ACTIVE CHART INSTANCES: ${chartInstances}</div>\n`;
                
                // ë¡œë“œëœ ìŠ¤í¬ë¦½íŠ¸ í™•ì¸
                const scripts = Array.from(document.querySelectorAll('script[src]'));
                const jsFiles = scripts.filter(s => s.src.includes('.js')).length;
                report += `<div class="success-indicator">ğŸ“œ LOADED JS FILES: ${jsFiles}</div>\n`;
                
                // ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰
                const memory = performance.memory;
                if (memory) {
                    const usedMB = Math.round(memory.usedJSHeapSize / 1024 / 1024);
                    const totalMB = Math.round(memory.totalJSHeapSize / 1024 / 1024);
                    report += `<div class="success-indicator">ğŸ’¾ MEMORY: ${usedMB}MB / ${totalMB}MB</div>\n`;
                }
                
                // ì‹¤ì œ ë°ì´í„° ë¡œë”© ìƒíƒœ í™•ì¸
                if (window.app && window.app.dataManager) {
                    report += `<div class="success-indicator">âœ… DATA MANAGER: Initialized</div>\n`;
                } else {
                    report += `<div class="error-indicator">âŒ DATA MANAGER: Not found or not initialized</div>\n`;
                }
                
                analysis.innerHTML = report;
                document.getElementById('dom-reality').className = 'test-section ' + (errorCount === 0 ? 'success' : 'warning');
                
            } catch (e) {
                analysis.innerHTML = `<div class="error-indicator">âŒ DOM ANALYSIS FAILED: ${e.message}</div>`;
                document.getElementById('dom-reality').className = 'test-section';
            }
        }

        // 2. ë„¤íŠ¸ì›Œí¬ ì‹¤íƒœ í™•ì¸
        async function testNetworkReality() {
            const container = document.getElementById('network-results');
            const endpoints = [
                'http://localhost:8091/api/stocks/live',
                '/data/raw/realtime_results.json',
                '/data/raw/sp500_prediction_data.json',
                '/js/data-manager.js',
                '/js/chart-manager.js'
            ];
            
            container.innerHTML = '';
            
            for (const endpoint of endpoints) {
                const card = document.createElement('div');
                card.className = 'test-card unknown';
                card.innerHTML = `<h4>${endpoint}</h4><div>í…ŒìŠ¤íŠ¸ ì¤‘...</div>`;
                container.appendChild(card);
                
                try {
                    const startTime = Date.now();
                    const response = await fetch(endpoint, { timeout: 5000 });
                    const endTime = Date.now();
                    const responseTime = endTime - startTime;
                    
                    if (response.ok) {
                        card.className = 'test-card pass';
                        card.innerHTML = `<h4>${endpoint}</h4><div>âœ… OK (${responseTime}ms)</div>`;
                    } else {
                        card.className = 'test-card fail';
                        card.innerHTML = `<h4>${endpoint}</h4><div>âŒ HTTP ${response.status}</div>`;
                    }
                } catch (error) {
                    card.className = 'test-card fail';
                    card.innerHTML = `<h4>${endpoint}</h4><div>âŒ ${error.message}</div>`;
                }
            }
        }

        // 3. ì‹¤ì œ ì°¨íŠ¸ ë Œë”ë§ í…ŒìŠ¤íŠ¸
        async function testChartReality() {
            const canvas = document.getElementById('reality-test-chart');
            const ctx = canvas.getContext('2d');
            const results = document.getElementById('chart-reality-results');
            
            try {
                // Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸
                if (!window.Chart) {
                    throw new Error('Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•ŠìŒ');
                }
                
                // ì‹¤ì œ APIì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                results.innerHTML += '<p>ğŸ”„ APIì—ì„œ ì‹¤ì œ ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” ì¤‘...</p>';
                const response = await fetch('http://localhost:8091/api/stocks/live');
                if (!response.ok) {
                    throw new Error(`API ì‘ë‹µ ì‹¤íŒ¨: ${response.status}`);
                }
                
                const data = await response.json();
                if (!data.predictions || data.predictions.length === 0) {
                    throw new Error('APIì—ì„œ ì£¼ì‹ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŒ');
                }
                
                // ì‹¤ì œ ì°¨íŠ¸ ìƒì„±
                results.innerHTML += '<p>ğŸ“Š ì‹¤ì œ ì°¨íŠ¸ ë Œë”ë§ ì¤‘...</p>';
                const stock = data.predictions[0];
                
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5'],
                        datasets: [{
                            label: `${stock.symbol} - $${stock.current_price}`,
                            data: [
                                stock.current_price * 0.98,
                                stock.current_price * 0.99,
                                stock.current_price,
                                stock.current_price * 1.01,
                                stock.current_price * 1.02
                            ],
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0,123,255,0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `ì‹¤ì œ ë°ì´í„° ì°¨íŠ¸: ${stock.symbol}`
                            }
                        }
                    }
                });
                
                // ì°¨íŠ¸ê°€ ì‹¤ì œë¡œ ë Œë”ë§ë˜ì—ˆëŠ”ì§€ í™•ì¸
                setTimeout(() => {
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const hasContent = imageData.data.some(pixel => pixel !== 0);
                    
                    if (hasContent) {
                        results.innerHTML = '<div class="success-indicator">âœ… ì°¨íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë Œë”ë§ë˜ì—ˆìŠµë‹ˆë‹¤!</div>';
                        document.getElementById('chart-reality').className = 'test-section success';
                    } else {
                        results.innerHTML = '<div class="error-indicator">âŒ ì°¨íŠ¸ê°€ ë¹ˆ ìº”ë²„ìŠ¤ì…ë‹ˆë‹¤!</div>';
                        document.getElementById('chart-reality').className = 'test-section';
                    }
                }, 1000);
                
            } catch (error) {
                results.innerHTML = `<div class="error-indicator">âŒ ì°¨íŠ¸ ë Œë”ë§ ì‹¤íŒ¨: ${error.message}</div>`;
                document.getElementById('chart-reality').className = 'test-section';
            }
        }

        // 4. ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸
        function runStressTest() {
            if (stressTestRunning) return;
            
            stressTestRunning = true;
            const results = document.getElementById('stress-results');
            let requestCount = 0;
            let failCount = 0;
            
            results.innerHTML = 'ğŸ”¥ ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...\n';
            
            stressInterval = setInterval(async () => {
                requestCount++;
                
                try {
                    const startTime = Date.now();
                    const response = await fetch('http://localhost:8091/api/stocks/live');
                    const endTime = Date.now();
                    
                    if (!response.ok) {
                        failCount++;
                    }
                    
                    const responseTime = endTime - startTime;
                    results.innerHTML = `ğŸ”¥ ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...\nìš”ì²­: ${requestCount}íšŒ\nì‹¤íŒ¨: ${failCount}íšŒ\në§ˆì§€ë§‰ ì‘ë‹µì‹œê°„: ${responseTime}ms\nì‹¤íŒ¨ìœ¨: ${((failCount/requestCount)*100).toFixed(1)}%`;
                    
                    if (failCount / requestCount > 0.1) { // 10% ì´ìƒ ì‹¤íŒ¨ì‹œ
                        results.innerHTML += '\nâš ï¸ ë†’ì€ ì‹¤íŒ¨ìœ¨ ê°ì§€!';
                    }
                    
                } catch (error) {
                    failCount++;
                    results.innerHTML = `ğŸ”¥ ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...\nìš”ì²­: ${requestCount}íšŒ\nì‹¤íŒ¨: ${failCount}íšŒ\në§ˆì§€ë§‰ ì—ëŸ¬: ${error.message}`;
                }
            }, 100); // 100msë§ˆë‹¤ ìš”ì²­
        }
        
        function stopStressTest() {
            if (stressInterval) {
                clearInterval(stressInterval);
                stressTestRunning = false;
                document.getElementById('stress-results').innerHTML += '\n\nâœ‹ ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ ì¤‘ë‹¨ë¨';
            }
        }

        // 5. ì¹˜ëª…ì  ê²°í•¨ íƒì§€
        function detectFatalFlaws() {
            const analysis = document.getElementById('fatal-analysis');
            let flaws = [];
            
            // ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ í™•ì¸
            if (performance.memory && performance.memory.usedJSHeapSize > 50 * 1024 * 1024) {
                flaws.push('ğŸš¨ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ê³¼ë‹¤ (50MB ì´ˆê³¼)');
            }
            
            // API ì˜ì¡´ì„± í™•ì¸
            if (!navigator.onLine) {
                flaws.push('ğŸš¨ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì—†ìŒ');
            }
            
            // í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸
            if (!window.Chart) {
                flaws.push('ğŸš¨ Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ëˆ„ë½');
            }
            
            // ì—ëŸ¬ ë°œìƒë¥  í™•ì¸
            if (errorCount > 5) {
                flaws.push(`ğŸš¨ ê³¼ë„í•œ JavaScript ì—ëŸ¬ ë°œìƒ (${errorCount}íšŒ)`);
            }
            
            // DOM ì¡°ì‘ í™•ì¸
            const stockGrids = document.querySelectorAll('.stock-grid');
            if (stockGrids.length === 0) {
                flaws.push('ğŸš¨ ì£¼ìš” UI ì»´í¬ë„ŒíŠ¸ ëˆ„ë½ (.stock-grid)');
            }
            
            // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ í™•ì¸
            const chartCount = Chart.instances ? Chart.instances.length : 0;
            if (chartCount === 0) {
                flaws.push('ğŸš¨ í™œì„± ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì—†ìŒ');
            }
            
            if (flaws.length === 0) {
                analysis.innerHTML = '<div class="success-indicator">âœ… ì¹˜ëª…ì  ê²°í•¨ ê°ì§€ë˜ì§€ ì•ŠìŒ</div>';
                document.getElementById('fatal-flaws').className = 'test-section success';
            } else {
                analysis.innerHTML = flaws.map(flaw => `<div class="error-indicator">${flaw}</div>`).join('\n');
                document.getElementById('fatal-flaws').className = 'test-section';
            }
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸° ë¶„ì„
        window.addEventListener('load', () => {
            setTimeout(() => {
                analyzeDOMReality();
                detectFatalFlaws();
            }, 2000);
        });
    </script>

    <!-- ì‹¤ì œ ì‹œìŠ¤í…œ ìŠ¤í¬ë¦½íŠ¸ë“¤ ë¡œë“œí•´ì„œ í…ŒìŠ¤íŠ¸ -->
    <script src="js/data-manager.js"></script>
    <script src="js/chart-manager.js"></script>
    <script src="js/components.js"></script>
</body>
</html>