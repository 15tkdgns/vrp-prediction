<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ğŸ” ì‹¤ì œ API ê°•ì œ í˜¸ì¶œ í…ŒìŠ¤íŠ¸</title>
    <style>
        body { 
            font-family: 'Courier New', monospace;
            background: #0d1117; 
            color: #c9d1d9; 
            margin: 20px; 
            font-size: 13px;
            line-height: 1.4;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: #161b22;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #30363d;
        }
        .status {
            padding: 8px 12px;
            margin: 8px 0;
            border-radius: 4px;
            border-left: 4px solid #238636;
            background: rgba(35, 134, 54, 0.1);
        }
        .error { 
            border-left-color: #f85149; 
            background: rgba(248, 81, 73, 0.1);
        }
        .warning { 
            border-left-color: #d29922; 
            background: rgba(210, 153, 34, 0.1);
        }
        .info { 
            border-left-color: #58a6ff; 
            background: rgba(88, 166, 255, 0.1);
        }
        pre { 
            background: #0d1117; 
            padding: 12px; 
            border-radius: 4px; 
            overflow-x: auto;
            border: 1px solid #21262d;
            font-size: 12px;
        }
        .test-btn {
            background: linear-gradient(135deg, #238636 0%, #1a6f2b 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-btn:hover { background: linear-gradient(135deg, #2ea043 0%, #238636 100%); }
        .test-btn:disabled { 
            background: #6c757d; 
            cursor: not-allowed; 
        }
        .logs {
            max-height: 400px;
            overflow-y: auto;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 12px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ì‹¤ì œ API ê°•ì œ í˜¸ì¶œ í…ŒìŠ¤íŠ¸</h1>
        <p>S&P 500 APIê°€ ì‹¤ì œë¡œ í˜¸ì¶œë˜ëŠ”ì§€ í™•ì¸í•˜ê³  ë¡œê·¸ë¥¼ ì¶”ì í•©ë‹ˆë‹¤.</p>
        
        <div>
            <button class="test-btn" onclick="testDirectYahooAPI()" id="yahooBtn">ğŸ“Š Yahoo Finance API ì§ì ‘ í…ŒìŠ¤íŠ¸</button>
            <button class="test-btn" onclick="testCORSProxies()" id="corsBtn">ğŸŒ CORS í”„ë¡ì‹œ í…ŒìŠ¤íŠ¸</button>
            <button class="test-btn" onclick="testSP500Widget()" id="widgetBtn">ğŸ¨ ìœ„ì ¯ API í˜¸ì¶œ í…ŒìŠ¤íŠ¸</button>
            <button class="test-btn" onclick="clearLogs()">ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>
        
        <div class="logs" id="logs">
            ì‹¤ì œ API í…ŒìŠ¤íŠ¸ ë„êµ¬ ì¤€ë¹„ë¨... ë²„íŠ¼ì„ í´ë¦­í•´ì„œ í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ì„¸ìš”.
        </div>
        
        <div id="results"></div>
    </div>

    <!-- API ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ -->
    <script src="js/api-service.js"></script>
    <script>
        const logsDiv = document.getElementById('logs');
        const resultsDiv = document.getElementById('results');
        
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<strong>[${time}]</strong> ${message}`;
            logsDiv.appendChild(div);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(`[${time}] ${message}`);
        }
        
        function clearLogs() {
            logsDiv.innerHTML = 'ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤...';
            resultsDiv.innerHTML = '';
        }
        
        function showData(data, title) {
            resultsDiv.innerHTML = `
                <div style="background: #161b22; border: 1px solid #30363d; padding: 15px; border-radius: 6px; margin-top: 15px;">
                    <h3>${title}</h3>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
        }
        
        // 1. Yahoo Finance API ì§ì ‘ í…ŒìŠ¤íŠ¸
        async function testDirectYahooAPI() {
            const btn = document.getElementById('yahooBtn');
            btn.disabled = true;
            btn.innerHTML = 'â³ í…ŒìŠ¤íŠ¸ ì¤‘...';
            
            log('ğŸŒ Yahoo Finance API ì§ì ‘ í˜¸ì¶œ ì‹œì‘...', 'info');
            
            try {
                // ì§ì ‘ í˜¸ì¶œ ì‹œë„
                const url = 'https://query1.finance.yahoo.com/v8/finance/chart/^GSPC?interval=1d&range=1d';
                log(`ğŸ“¡ ì§ì ‘ í˜¸ì¶œ URL: ${url}`, 'info');
                
                try {
                    const response = await fetch(url, { 
                        mode: 'cors',
                        headers: {
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        log('âœ… ì§ì ‘ í˜¸ì¶œ ì„±ê³µ!', 'info');
                        
                        if (data.chart && data.chart.result && data.chart.result[0]) {
                            const result = data.chart.result[0];
                            const meta = result.meta;
                            const quotes = result.indicators.quote[0];
                            const latestPrice = quotes.close[quotes.close.length - 1];
                            
                            const sp500Data = {
                                current: parseFloat(latestPrice.toFixed(2)),
                                change: parseFloat((meta.regularMarketChangePercent || 0).toFixed(2)),
                                volume: parseInt(meta.regularMarketVolume || 0),
                                timestamp: new Date().toISOString(),
                                source: 'Yahoo Finance (Direct)'
                            };
                            
                            log(`ğŸ“Š S&P 500 í˜„ì¬ê°€: $${sp500Data.current}`, 'info');
                            log(`ğŸ“ˆ ë³€ë™ë¥ : ${sp500Data.change}%`, 'info');
                            log(`ğŸ“¦ ê±°ë˜ëŸ‰: ${sp500Data.volume.toLocaleString()}`, 'info');
                            
                            showData(sp500Data, 'âœ… Yahoo Finance API ì§ì ‘ í˜¸ì¶œ ì„±ê³µ');
                        }
                    } else {
                        log(`âŒ ì§ì ‘ í˜¸ì¶œ HTTP ì˜¤ë¥˜: ${response.status}`, 'error');
                    }
                } catch (directError) {
                    log(`âŒ ì§ì ‘ í˜¸ì¶œ ì‹¤íŒ¨ (ì˜ˆìƒë¨): ${directError.message}`, 'warning');
                    log('ğŸ”„ CORS í”„ë¡ì‹œë¡œ ì¬ì‹œë„...', 'info');
                    
                    // CORS í”„ë¡ì‹œ ì‚¬ìš©
                    const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
                    log(`ğŸŒ í”„ë¡ì‹œ URL: ${proxyUrl}`, 'info');
                    
                    const proxyResponse = await fetch(proxyUrl);
                    if (proxyResponse.ok) {
                        const data = await proxyResponse.json();
                        log('âœ… CORS í”„ë¡ì‹œ í˜¸ì¶œ ì„±ê³µ!', 'info');
                        
                        if (data.chart && data.chart.result && data.chart.result[0]) {
                            const result = data.chart.result[0];
                            const meta = result.meta;
                            const quotes = result.indicators.quote[0];
                            const latestPrice = quotes.close[quotes.close.length - 1];
                            
                            const sp500Data = {
                                current: parseFloat(latestPrice.toFixed(2)),
                                change: parseFloat((meta.regularMarketChangePercent || 0).toFixed(2)),
                                volume: parseInt(meta.regularMarketVolume || 0),
                                timestamp: new Date().toISOString(),
                                source: 'Yahoo Finance (via Proxy)'
                            };
                            
                            log(`ğŸ“Š S&P 500 í˜„ì¬ê°€: $${sp500Data.current}`, 'info');
                            log(`ğŸ“ˆ ë³€ë™ë¥ : ${sp500Data.change}%`, 'info');
                            log(`ğŸ“¦ ê±°ë˜ëŸ‰: ${sp500Data.volume.toLocaleString()}`, 'info');
                            
                            showData(sp500Data, 'âœ… Yahoo Finance API (CORS í”„ë¡ì‹œ) ì„±ê³µ');
                        }
                    } else {
                        log(`âŒ í”„ë¡ì‹œ í˜¸ì¶œë„ ì‹¤íŒ¨: ${proxyResponse.status}`, 'error');
                    }
                }
                
            } catch (error) {
                log(`ğŸ’¥ ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸ“Š Yahoo Finance API ì§ì ‘ í…ŒìŠ¤íŠ¸';
            }
        }
        
        // 2. CORS í”„ë¡ì‹œë“¤ í…ŒìŠ¤íŠ¸
        async function testCORSProxies() {
            const btn = document.getElementById('corsBtn');
            btn.disabled = true;
            btn.innerHTML = 'â³ í…ŒìŠ¤íŠ¸ ì¤‘...';
            
            log('ğŸŒ CORS í”„ë¡ì‹œ ì„œë²„ë“¤ í…ŒìŠ¤íŠ¸ ì‹œì‘...', 'info');
            
            const proxies = [
                'https://api.allorigins.win/raw?url=',
                'https://cors-proxy.fringe.zone/',
                'https://api.codetabs.com/v1/proxy?quest=',
                'https://corsproxy.io/?'
            ];
            
            const testUrl = 'https://query1.finance.yahoo.com/v8/finance/chart/^GSPC?interval=1d&range=1d';
            
            for (let i = 0; i < proxies.length; i++) {
                const proxy = proxies[i];
                log(`ğŸ”„ í”„ë¡ì‹œ ${i+1} í…ŒìŠ¤íŠ¸: ${proxy}`, 'info');
                
                try {
                    const proxyUrl = proxy + encodeURIComponent(testUrl);
                    const startTime = Date.now();
                    
                    const response = await Promise.race([
                        fetch(proxyUrl),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('15ì´ˆ íƒ€ì„ì•„ì›ƒ')), 15000)
                        )
                    ]);
                    
                    const elapsed = Date.now() - startTime;
                    
                    if (response.ok) {
                        log(`âœ… í”„ë¡ì‹œ ${i+1} ì„±ê³µ (${elapsed}ms)`, 'info');
                        
                        // ì²« ë²ˆì§¸ ì„±ê³µí•œ í”„ë¡ì‹œë¡œ ì‹¤ì œ ë°ì´í„° íŒŒì‹±
                        if (i === 0) {
                            const data = await response.json();
                            if (data.chart && data.chart.result && data.chart.result[0]) {
                                const result = data.chart.result[0];
                                const meta = result.meta;
                                log(`ğŸ“Š í”„ë¡ì‹œë¡œ ë°›ì€ S&P 500: $${meta.regularMarketPrice}`, 'info');
                            }
                        }
                    } else {
                        log(`âŒ í”„ë¡ì‹œ ${i+1} HTTP ì˜¤ë¥˜: ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`âŒ í”„ë¡ì‹œ ${i+1} ì‹¤íŒ¨: ${error.message}`, 'error');
                }
            }
            
            btn.disabled = false;
            btn.innerHTML = 'ğŸŒ CORS í”„ë¡ì‹œ í…ŒìŠ¤íŠ¸';
        }
        
        // 3. S&P 500 ìœ„ì ¯ API í˜¸ì¶œ í…ŒìŠ¤íŠ¸
        async function testSP500Widget() {
            const btn = document.getElementById('widgetBtn');
            btn.disabled = true;
            btn.innerHTML = 'â³ í…ŒìŠ¤íŠ¸ ì¤‘...';
            
            log('ğŸ¨ S&P 500 ìœ„ì ¯ API í˜¸ì¶œ í…ŒìŠ¤íŠ¸...', 'info');
            
            try {
                // API ì„œë¹„ìŠ¤ ì´ˆê¸°í™”
                if (!window.apiService) {
                    log('ğŸ”§ APIService ì´ˆê¸°í™”...', 'info');
                    window.apiService = new APIService();
                }
                
                // S&P 500 ë°ì´í„° í˜¸ì¶œ
                log('ğŸ“Š S&P 500 ë°ì´í„° ìš”ì²­...', 'info');
                const sp500Data = await window.apiService.getSP500Current();
                
                if (sp500Data && sp500Data.current > 0) {
                    log('âœ… ìœ„ì ¯ API í˜¸ì¶œ ì„±ê³µ!', 'info');
                    log(`ğŸ“Š í˜„ì¬ê°€: $${sp500Data.current}`, 'info');
                    log(`ğŸ“ˆ ë³€ë™ë¥ : ${sp500Data.change}%`, 'info');
                    log(`ğŸ¯ ë°ì´í„° ì†ŒìŠ¤: ${sp500Data.source}`, 'info');
                    
                    showData(sp500Data, 'âœ… S&P 500 ìœ„ì ¯ API í˜¸ì¶œ ì„±ê³µ');
                } else {
                    log('âŒ ìœ„ì ¯ API í˜¸ì¶œ ì‹¤íŒ¨ - null ë˜ëŠ” ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„°', 'error');
                    showData(sp500Data, 'âŒ S&P 500 ìœ„ì ¯ API í˜¸ì¶œ ì‹¤íŒ¨');
                }
                
            } catch (error) {
                log(`ğŸ’¥ ìœ„ì ¯ API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸ¨ ìœ„ì ¯ API í˜¸ì¶œ í…ŒìŠ¤íŠ¸';
            }
        }
        
        // ìë™ ì‹œì‘
        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸš€ ì‹¤ì œ API í…ŒìŠ¤íŠ¸ ë„êµ¬ ë¡œë“œë¨', 'info');
            log('ğŸ’¡ ê° ë²„íŠ¼ì„ í´ë¦­í•´ì„œ API ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”', 'info');
            
            // 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ì²« ë²ˆì§¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
            setTimeout(() => {
                log('ğŸ¤– ìë™ í…ŒìŠ¤íŠ¸ ì‹œì‘...', 'info');
                testDirectYahooAPI();
            }, 3000);
        });
        
    </script>
</body>
</html>