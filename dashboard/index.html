<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Stock Prediction Dashboard</title>
    <meta
      name="description"
      content="AI 기반 주식 예측 대시보드 - S&P 500 및 주요 종목 분석"
    />

    <!-- CSS -->
    <link rel="stylesheet" href="css/styles.css" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Favicon -->
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📊</text></svg>"
    />
  </head>

  <body>
    <!-- 로딩 인디케이터 -->
    <div id="loading-indicator">로딩 중...</div>

    <!-- 상태 메시지 -->
    <div id="status-message"></div>

    <!-- 사이드바 오버레이 -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <!-- 메인 컨테이너 -->
    <div class="dashboard-container">
      <!-- 헤더 -->
      <header class="dashboard-header">
        <div class="header-content">
          <button id="sidebar-toggle" class="sidebar-toggle">☰</button>
          <h1 class="header-title">📊 AI Stock Dashboard</h1>
          <div class="header-controls">
            <span id="current-page-title" class="current-page">대시보드</span>
            <button id="refresh-btn" class="btn btn-primary">
              🔄 새로고침
            </button>
            <div id="last-update" class="text-muted" style="font-size: 0.9rem">
              <!-- 마지막 업데이트 시간 -->
            </div>
          </div>
        </div>
      </header>

      <!-- 사이드바 -->
      <nav id="sidebar" class="sidebar">
        <div class="sidebar-header">
          <h3>📈 메뉴</h3>
          <button id="sidebar-close" class="sidebar-close">✕</button>
        </div>
        <ul class="sidebar-menu">
          <li class="menu-item active" data-page="overview">
            <a href="#overview" class="menu-link">
              <span class="menu-icon">📊</span>
              <span class="menu-text">대시보드 개요</span>
            </a>
          </li>
          <li class="menu-item" data-page="stocks">
            <a href="#stocks" class="menu-link">
              <span class="menu-icon">📈</span>
              <span class="menu-text">주식 분석</span>
            </a>
          </li>
          <li class="menu-item" data-page="charts">
            <a href="#charts" class="menu-link">
              <span class="menu-icon">📋</span>
              <span class="menu-text">차트 분석</span>
            </a>
          </li>
          <li class="menu-item" data-page="news">
            <a href="#news" class="menu-link">
              <span class="menu-icon">📰</span>
              <span class="menu-text">뉴스 & 감정</span>
            </a>
          </li>
          <li class="menu-item" data-page="performance">
            <a href="#performance" class="menu-link">
              <span class="menu-icon">🎯</span>
              <span class="menu-text">모델 성능</span>
            </a>
          </li>
          <li class="menu-item" data-page="training">
            <a href="#training" class="menu-link">
              <span class="menu-icon">🧠</span>
              <span class="menu-text">학습 과정 & XAI</span>
            </a>
          </li>
          <li class="menu-item" data-page="settings">
            <a href="#settings" class="menu-link">
              <span class="menu-icon">⚙️</span>
              <span class="menu-text">설정</span>
            </a>
          </li>
        </ul>
      </nav>

      <!-- 메인 콘텐츠 -->
      <main class="main-content" id="main-content">
        <!-- 대시보드 개요 페이지 -->
        <div id="page-overview" class="page-content active">
          <div class="page-header">
            <h2>📊 대시보드 개요</h2>
            <p>AI 주식 예측 시스템의 전체 현황을 한눈에 확인하세요</p>
          </div>
          <div class="dashboard-grid">
            <!-- S&P 500 실시간 위젯 -->
            <section
              class="sp500-widget"
              style="grid-column: 1 / -1; margin-bottom: 2rem"
            >
              <div class="sp500-container">
                <div class="sp500-header">
                  <h3>📈 S&P 500 실시간 가격 & 예측</h3>
                  <span id="sp500-last-update" class="last-update"></span>
                </div>
                <div class="sp500-content">
                  <div class="sp500-price-section">
                    <div class="sp500-current-price">
                      <span class="price-label">현재 가격</span>
                      <span id="sp500-current-price" class="price-value"
                        >$4,580.23</span
                      >
                      <span
                        id="sp500-price-change"
                        class="price-change positive"
                        >+15.67 (+0.34%)</span
                      >
                    </div>
                    <div class="sp500-prediction">
                      <span class="prediction-label">AI 예측</span>
                      <span id="sp500-predicted-price" class="prediction-value"
                        >$4,642.15</span
                      >
                      <span id="sp500-prediction-confidence" class="confidence"
                        >신뢰도: 82%</span
                      >
                    </div>
                  </div>
                  <div class="sp500-chart-section">
                    <canvas
                      id="sp500-30day-chart"
                      width="400"
                      height="200"
                    ></canvas>
                  </div>
                </div>
              </div>
            </section>

            <section class="stock-grid" style="grid-column: 1 / -1">
              <!-- StockGrid 컴포넌트 -->
            </section>
            <section class="metrics-panel">
              <!-- MetricsPanel 컴포넌트 -->
            </section>
            <section class="news-panel">
              <!-- NewsPanel 컴포넌트 -->
            </section>
          </div>
        </div>

        <!-- 주식 분석 페이지 -->
        <div id="page-stocks" class="page-content">
          <div class="page-header">
            <h2>📈 주식 분석</h2>
            <p>실시간 주식 데이터와 AI 예측 결과</p>
          </div>
          <div class="dashboard-grid">
            <section class="stock-grid" style="grid-column: 1 / -1">
              <!-- 확장된 StockGrid 컴포넌트 -->
            </section>
            <section class="stock-details" style="grid-column: 1 / -1">
              <!-- 상세 주식 정보 -->
            </section>
          </div>
        </div>

        <!-- 차트 분석 페이지 -->
        <div id="page-charts" class="page-content">
          <div class="page-header">
            <h2>📋 차트 분석</h2>
            <p>다양한 차트와 기술적 분석 도구</p>
          </div>
          <div class="dashboard-grid">
            <section class="chart-container" style="grid-column: 1 / -1">
              <!-- ChartContainer 컴포넌트 -->
            </section>
            <section class="technical-analysis" style="grid-column: 1 / -1">
              <!-- 기술적 분석 위젯 -->
            </section>
          </div>
        </div>

        <!-- 뉴스 & 감정 분석 페이지 -->
        <div id="page-news" class="page-content">
          <div class="page-header">
            <h2>📰 뉴스 & 감정 분석</h2>
            <p>시장 뉴스와 감정 분석 결과</p>
          </div>
          <div class="dashboard-grid">
            <section class="news-panel enhanced" style="grid-column: 1 / -1">
              <!-- 확장된 NewsPanel 컴포넌트 -->
            </section>
            <section class="sentiment-details" style="grid-column: 1 / -1">
              <!-- 상세 감정 분석 -->
            </section>
          </div>
        </div>

        <!-- 모델 성능 페이지 -->
        <div id="page-performance" class="page-content">
          <div class="page-header">
            <h2>🎯 모델 성능</h2>
            <p>AI 모델의 성능 지표와 분석</p>
          </div>
          <div class="dashboard-grid">
            <section class="metrics-panel enhanced" style="grid-column: 1 / -1">
              <!-- 확장된 MetricsPanel 컴포넌트 -->
            </section>
            <section class="model-comparison" style="grid-column: 1 / -1">
              <!-- 모델 비교 분석 -->
            </section>
          </div>
        </div>

        <!-- 학습 과정 & XAI 페이지 -->
        <div id="page-training" class="page-content">
          <div class="page-header">
            <h2>🧠 모델 학습 과정 & 설명 가능한 AI</h2>
            <p>모델 학습 파라미터, 주요 변수 분석 및 XAI 시각화</p>
          </div>
          
          <!-- 학습 파라미터 섹션 -->
          <section class="training-parameters-section" style="margin-bottom: 2rem;">
            <div class="section-header">
              <h3>📊 학습 파라미터 & 모델 구성</h3>
            </div>
            <div class="parameters-grid">
              <div class="parameter-card">
                <h4>🌳 Random Forest</h4>
                <div class="parameter-details">
                  <div class="param-item">
                    <span class="param-label">트리 개수:</span>
                    <span class="param-value">100</span>
                  </div>
                  <div class="param-item">
                    <span class="param-label">최대 깊이:</span>
                    <span class="param-value">10</span>
                  </div>
                  <div class="param-item">
                    <span class="param-label">분할 기준:</span>
                    <span class="param-value">Gini</span>
                  </div>
                  <div class="param-item">
                    <span class="param-label">가중치:</span>
                    <span id="rf-weight" class="param-value">34.2%</span>
                  </div>
                </div>
              </div>
              
              <div class="parameter-card">
                <h4>🚀 Gradient Boosting</h4>
                <div class="parameter-details">
                  <div class="param-item">
                    <span class="param-label">학습률:</span>
                    <span class="param-value">0.1</span>
                  </div>
                  <div class="param-item">
                    <span class="param-label">추정기 개수:</span>
                    <span class="param-value">100</span>
                  </div>
                  <div class="param-item">
                    <span class="param-label">최대 깊이:</span>
                    <span class="param-value">3</span>
                  </div>
                  <div class="param-item">
                    <span class="param-label">가중치:</span>
                    <span id="gb-weight" class="param-value">34.5%</span>
                  </div>
                </div>
              </div>
              
              <div class="parameter-card">
                <h4>🧠 LSTM</h4>
                <div class="parameter-details">
                  <div class="param-item">
                    <span class="param-label">LSTM 유닛:</span>
                    <span class="param-value">50</span>
                  </div>
                  <div class="param-item">
                    <span class="param-label">Dropout:</span>
                    <span class="param-value">0.2</span>
                  </div>
                  <div class="param-item">
                    <span class="param-label">시퀀스 길이:</span>
                    <span class="param-value">60일</span>
                  </div>
                  <div class="param-item">
                    <span class="param-label">가중치:</span>
                    <span id="lstm-weight" class="param-value">31.3%</span>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- 캘리브레이션 정보 섹션 -->
          <section class="calibration-section" style="margin-bottom: 2rem;">
            <div class="section-header">
              <h3>🎯 확률 캘리브레이션 정보</h3>
            </div>
            <div class="calibration-grid">
              <div class="calibration-card">
                <h4>📈 Platt Scaling</h4>
                <p>시그모이드 함수를 사용한 확률 캘리브레이션</p>
                <div class="calibration-metrics">
                  <div class="metric">
                    <span class="metric-label">적용 모델:</span>
                    <span class="metric-value">Gradient Boosting</span>
                  </div>
                  <div class="metric">
                    <span class="metric-label">개선 효과:</span>
                    <span class="metric-value">Brier Score 감소</span>
                  </div>
                </div>
              </div>
              
              <div class="calibration-card">
                <h4>📊 Isotonic Regression</h4>
                <p>단조증가 함수를 사용한 비모수 캘리브레이션</p>
                <div class="calibration-metrics">
                  <div class="metric">
                    <span class="metric-label">적용 모델:</span>
                    <span class="metric-value">Random Forest</span>
                  </div>
                  <div class="metric">
                    <span class="metric-label">개선 효과:</span>
                    <span class="metric-value">신뢰도 안정화</span>
                  </div>
                </div>
              </div>
              
              <div class="calibration-card">
                <h4>🎲 Bootstrap 신뢰구간</h4>
                <p>500회 반복을 통한 불확실성 정량화</p>
                <div class="calibration-metrics">
                  <div class="metric">
                    <span class="metric-label">반복 횟수:</span>
                    <span class="metric-value">500회</span>
                  </div>
                  <div class="metric">
                    <span class="metric-label">신뢰구간:</span>
                    <span class="metric-value">95%</span>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- XAI 시각화 섹션 -->
          <section class="xai-visualization-section" style="margin-bottom: 2rem;">
            <div class="section-header">
              <h3>🔍 설명 가능한 AI (XAI) 분석</h3>
            </div>
            <div class="xai-grid">
              <div class="xai-card">
                <h4>📊 특성 중요도 (Feature Importance)</h4>
                <canvas id="feature-importance-chart" width="500" height="300"></canvas>
              </div>
              
              <div class="xai-card">
                <h4>🎯 모델 성능 비교</h4>
                <canvas id="model-comparison-chart" width="500" height="300"></canvas>
              </div>
              
              <div class="xai-card">
                <h4>📈 신뢰도 분포</h4>
                <canvas id="confidence-distribution-chart" width="500" height="300"></canvas>
              </div>
              
              <div class="xai-card">
                <h4>⚖️ 캘리브레이션 곡선</h4>
                <canvas id="calibration-curve-chart" width="500" height="300"></canvas>
              </div>
            </div>
          </section>

          <!-- 주요 변수 분석 섹션 -->
          <section class="key-variables-section">
            <div class="section-header">
              <h3>🔑 주요 변수 분석</h3>
            </div>
            <div class="variables-grid">
              <div class="variable-card">
                <h4>💰 가격 변수</h4>
                <ul class="variable-list">
                  <li><span class="var-name">현재가:</span> <span class="var-desc">S&P500 현재 지수</span></li>
                  <li><span class="var-name">종가:</span> <span class="var-desc">이전 거래일 종가</span></li>
                  <li><span class="var-name">고가/저가:</span> <span class="var-desc">일중 최고/최저가</span></li>
                  <li><span class="var-name">가격 변화율:</span> <span class="var-desc">전일 대비 변화율</span></li>
                </ul>
              </div>
              
              <div class="variable-card">
                <h4>📊 기술적 지표</h4>
                <ul class="variable-list">
                  <li><span class="var-name">RSI:</span> <span class="var-desc">상대강도지수 (과매수/과매도)</span></li>
                  <li><span class="var-name">MACD:</span> <span class="var-desc">이동평균수렴확산 지표</span></li>
                  <li><span class="var-name">볼린저 밴드:</span> <span class="var-desc">가격 변동성 측정</span></li>
                  <li><span class="var-name">ATR:</span> <span class="var-desc">평균 진정한 범위</span></li>
                </ul>
              </div>
              
              <div class="variable-card">
                <h4>📈 거래량 변수</h4>
                <ul class="variable-list">
                  <li><span class="var-name">거래량:</span> <span class="var-desc">일일 거래량</span></li>
                  <li><span class="var-name">거래량 변화:</span> <span class="var-desc">평균 대비 거래량 변화</span></li>
                  <li><span class="var-name">거래량 스파이크:</span> <span class="var-desc">1.3배 이상 급증 여부</span></li>
                  <li><span class="var-name">평균 거래량:</span> <span class="var-desc">20일 이동평균 거래량</span></li>
                </ul>
              </div>
              
              <div class="variable-card">
                <h4>🎯 이벤트 정의</h4>
                <ul class="variable-list">
                  <li><span class="var-name">가격 이벤트:</span> <span class="var-desc">±2% 이상 변동</span></li>
                  <li><span class="var-name">거래량 이벤트:</span> <span class="var-desc">1.3배 이상 증가</span></li>
                  <li><span class="var-name">복합 이벤트:</span> <span class="var-desc">가격 + 거래량 동시 발생</span></li>
                  <li><span class="var-name">이벤트 비율:</span> <span class="var-desc">46% (최적화됨)</span></li>
                </ul>
              </div>
            </div>
          </section>
        </div>

        <!-- 설정 페이지 -->
        <div id="page-settings" class="page-content">
          <div class="page-header">
            <h2>⚙️ 설정</h2>
            <p>대시보드 설정 및 환경 구성</p>
          </div>
          <div class="settings-grid">
            <section class="api-settings">
              <!-- API 설정 -->
            </section>
            <section class="refresh-settings">
              <!-- 새로고침 설정 -->
            </section>
            <section class="display-settings">
              <!-- 디스플레이 설정 -->
            </section>
          </div>
        </div>
      </main>

      <!-- 푸터 -->
      <footer
        style="
          text-align: center;
          padding: 2rem;
          color: var(--text-secondary);
          font-size: 0.9rem;
        "
      >
        <p>
          &copy; 2025 AI Stock Dashboard. 데이터는 실시간으로 업데이트됩니다.
        </p>
        <p style="margin-top: 0.5rem">
          <span id="system-status">시스템 상태: 정상</span> |
          <span id="data-source">데이터 소스: 로컬</span> |
          <span id="chart-count">차트: 0개</span>
        </p>
      </footer>
    </div>

    <!-- JavaScript -->
    <script src="js/data-manager.js"></script>
    <script src="js/chart-manager.js"></script>
    <script src="js/sp500-widget.js"></script>
    <script src="js/xai-visualization.js"></script>
    <script src="js/page-router.js"></script>
    <script src="js/components.js"></script>
    <script src="js/app.js"></script>

    <!-- 메인 애플리케이션 초기화 -->
    <script>
      // 전역 앱 인스턴스
      let app;

      // DOM 로드 완료시 앱 초기화
      document.addEventListener('DOMContentLoaded', async () => {
        try {
          console.log('🚀 AI Stock Dashboard 시작...');

          // 앱 인스턴스 생성 및 초기화
          app = new DashboardApp();
          window.app = app; // 전역 접근용

          // 페이지 라우터 초기화
          window.pageRouter = new PageRouter();
          window.pageRouter.init();

          await app.init();

          // 상태 정보 업데이트
          updateSystemInfo();
        } catch (error) {
          console.error('❌ 애플리케이션 초기화 실패:', error);
          showFallbackError(error);
        }
      });

      // 시스템 정보 업데이트
      function updateSystemInfo() {
        try {
          // 시스템 상태
          const statusEl = document.getElementById('system-status');
          if (statusEl) {
            statusEl.textContent =
              app && app.isInitialized
                ? '시스템 상태: 정상'
                : '시스템 상태: 초기화 중';
            statusEl.style.color =
              app && app.isInitialized
                ? 'var(--success-color)'
                : 'var(--warning-color)';
          }

          // 차트 수
          const chartCountEl = document.getElementById('chart-count');
          if (chartCountEl && app && app.chartManager) {
            const chartCount = app.chartManager.charts.size;
            chartCountEl.textContent = `차트: ${chartCount}개`;
          }

          // 마지막 업데이트
          const lastUpdateEl = document.getElementById('last-update');
          if (lastUpdateEl && app && app.state.lastUpdate) {
            lastUpdateEl.textContent = `업데이트: ${formatTime(app.state.lastUpdate)}`;
          }
        } catch (error) {
          console.warn('시스템 정보 업데이트 실패:', error);
        }
      }

      // 시간 포맷팅
      function formatTime(date) {
        if (!date) return '알 수 없음';
        return new Intl.DateTimeFormat('ko-KR', {
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
        }).format(date);
      }

      // 폴백 에러 표시
      function showFallbackError(error) {
        document.querySelector('.main-content').innerHTML = `
                <div style="text-align: center; padding: 3rem; color: var(--danger-color);">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">⚠️</div>
                    <h2>시스템 초기화 실패</h2>
                    <p style="margin: 1rem 0; color: var(--text-secondary);">
                        ${error.message || '알 수 없는 오류가 발생했습니다.'}
                    </p>
                    <button class="btn btn-primary" onclick="location.reload()">
                        페이지 새로고침
                    </button>
                    <div style="margin-top: 2rem; font-size: 0.9rem; color: var(--text-muted);">
                        문제가 지속되면 브라우저 콘솔을 확인하세요.
                    </div>
                </div>
            `;
      }

      // 5초마다 시스템 정보 업데이트
      setInterval(updateSystemInfo, 5000);

      // 전역 에러 처리
      window.addEventListener('error', (event) => {
        console.error('전역 에러 발생:', event.error);
      });

      window.addEventListener('unhandledrejection', (event) => {
        console.error('처리되지 않은 Promise 거부:', event.reason);
        event.preventDefault();
      });

      // 디버그용 전역 함수들
      window.getAppDebugInfo = () => {
        if (!app) return { error: 'App not initialized' };
        return app.getDebugInfo();
      };

      window.forceRefresh = () => {
        if (app) {
          app.refresh();
        } else {
          location.reload();
        }
      };

      console.log('📱 Dashboard HTML 로드 완료');
    </script>
  </body>
</html>
